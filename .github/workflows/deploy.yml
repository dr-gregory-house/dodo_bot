name: CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd ~/dodo_bot
          
          # Inject Secrets
          echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" > .env
          echo "GOOGLE_SERVICE_ACCOUNT_FILE=service_account.json" >> .env
          echo "SPREADSHEET_ID=${{ secrets.SPREADSHEET_ID }}" >> .env
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
          
          echo '${{ secrets.GOOGLE_CREDENTIALS }}' > service_account.json
          
          # Fetch latest update.sh from GitHub
          mkdir -p deployment
          curl -sL https://raw.githubusercontent.com/dr-gregory-house/dodo_bot/main/deployment/update.sh -o deployment/update.sh
          chmod +x deployment/update.sh
          
          # Reset git state to avoid conflicts (if git repo exists)
          if [ -d .git ]; then
            git fetch origin || true
            git reset --hard origin/main || true
          fi
          
          # Run Update
          ./deployment/update.sh

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
