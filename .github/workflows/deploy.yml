name: CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd ~/dodo_bot
          
          # Inject Secrets
          echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" > .env
          echo "GOOGLE_SERVICE_ACCOUNT_FILE=service_account.json" >> .env
          echo "SPREADSHEET_ID=${{ secrets.SPREADSHEET_ID }}" >> .env
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
          
          echo '${{ secrets.GOOGLE_CREDENTIALS }}' > service_account.json
          
          # Fetch latest update.sh from GitHub
          mkdir -p deployment
          curl -sL https://raw.githubusercontent.com/dr-gregory-house/dodo_bot/main/deployment/update.sh -o deployment/update.sh
          chmod +x deployment/update.sh
          
          # Reset git state to avoid conflicts (if git repo exists)
          if [ -d .git ]; then
            git fetch origin || true
            git reset --hard origin/main || true
          fi
          
          # Run Update
          ./deployment/update.sh
