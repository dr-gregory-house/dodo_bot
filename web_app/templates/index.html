<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dodo Cold Shop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <div class="container">
        <header>
            <h1>‚ùÑÔ∏è –•–æ–ª–æ–¥–Ω—ã–π –¶–µ—Ö</h1>
            <div id="clock" class="clock">00:00</div>
        </header>

        <main>


            <section class="card preps-card">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('morning')">‚òÄÔ∏è –£—Ç—Ä–æ</button>
                    <button class="tab-btn" onclick="switchTab('evening')">üåô –í–µ—á–µ—Ä</button>
                </div>
                <div id="preps-content" class="content-box loading">
                    –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
            </section>


        </main>

        <footer>
            <button onclick="refreshData()" class="refresh-btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </footer>
    </div>

    <script>
        let prepsData = null;

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        async function fetchData() {
            document.getElementById('preps-content').classList.add('loading');

            try {
                // Fetch Preps
                const prepsRes = await fetch('/api/preps');
                prepsData = await prepsRes.json();

                // Determine current tab based on time if first load, or keep current
                renderPreps();
                document.getElementById('preps-content').classList.remove('loading');

            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('preps-content').innerText = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            }
        }

        function renderPreps() {
            if (!prepsData) return;

            const activeTabBtn = document.querySelector('.tab-btn.active');
            // Default to morning if no active tab
            let tab = 'morning';
            if (activeTabBtn) {
                tab = activeTabBtn.getAttribute('onclick').includes('morning') ? 'morning' : 'evening';
            } else {
                // If no active tab, set based on is_morning from backend or default
                if (prepsData.is_morning) {
                    tab = 'morning';
                    document.querySelector('button[onclick="switchTab(\'morning\')"]').classList.add('active');
                } else {
                    tab = 'evening';
                    document.querySelector('button[onclick="switchTab(\'evening\')"]').classList.add('active');
                }
            }

            let content = prepsData[tab];

            // Markdown parsing (simple)
            // Bold
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Code/Monospace
            content = content.replace(/`(.*?)`/g, '<code class="quantity">$1</code>');
            // Newlines
            content = content.replace(/\n/g, '<br>');

            document.getElementById('preps-content').innerHTML = content;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            // Fix: Use a more robust selector or just pass 'this'
            // But for now, let's just find by onclick attribute which matches exactly
            const btn = document.querySelector(`button[onclick="switchTab('${tab}')"]`);
            if (btn) btn.classList.add('active');
            renderPreps();
        }

        function refreshData() {
            fetchData();
        }

        // Initial load
        fetchData();
    </script>
</body>

</html>